<!DOCTYPE html>

<html>

<head><title>Hangman's game</title>

	<h2>Powered with words and definitions from Merriam-Webster's Learners Dictionary<p></p>
	<img src="Merriam-Webster_logo.png"></h2>

</head>

<body style="background-color:rgb(192,226,211)">
	<h1 style="text-align:center;color:rgb(48,16,78)"><strong>This is <em>Hangman's</em> game</strong></h1>
	<p style="text-align:center"><img src="hangman.png" height=250 width=250></p>
	<p>If you want to check your spelling, go to <a href="https://www.merriam-webster.com">Merriam-Webster online</a> and good luck!</p>

	<div id="game-info" style="margin-top: 20px;">
		<h3>Word definition from Merriam-Webster's Learner Dictionary:</h3>
		<p id="word-definition" style="font-style: italic;"></p>
		<button id="new-word-button">Choose another word</button>
	</div>

	
    <div id="game-container" style="text-align: center">
        <h2 id="word-mask"></h2>    <p id="guesses-left"></p>   <p id="message-area"></p>  <p id="feedback-area"></p> 
		<label for="guess-input">Enter a letter:</label>
        <input type="text" id="guess-input" maxlength="1" style="width: 50px">
		<p></p>
        <button id="submit-guess">Check response</button>
    </div>

    <script src="https://code.jquery.com/jquery-2.1.0.js"></script>
    
    <script>
    
    // -----------------------------------------------------------------------
    // 1. КОНФИГУРАЦИЯ
    // -----------------------------------------------------------------------
    const MW_API_KEY = `62ef63d6-1b72-4711-867f-2f2b6152b0da`; 
    const MW_DICTIONARY_URL = `https://www.dictionaryapi.com/api/v3/references/learners/json/`; 
    
    // Нов файл за думите
    const WORD_LIST_FILE = 'words.txt'; 
    let WORDS_ARRAY = []; // Тук ще съхраняваме думите от файла
    
    
    // -----------------------------------------------------------------------
    // 2. ФУНКЦИЯ ЗА ЗАРЕЖДАНЕ НА ДУМИТЕ (НОВА)
    // -----------------------------------------------------------------------
    async function fetchWordList() {
        try {
            // Извличане на съдържанието на локалния текстов файл
            const response = await fetch(WORD_LIST_FILE);
            if (!response.ok) {
                throw new Error('Failed to load word list file from server.');
            }
            
            const text = await response.text();
            
            // Разделяне на текста на думи (по нов ред), филтриране на празни редове и попълване на глобалния масив
            WORDS_ARRAY = text.split('\n')
                              .map(word => word.trim().toLowerCase())
                              .filter(word => word.length > 0 && /^[a-z]+$/.test(word));
            
            if (WORDS_ARRAY.length === 0) {
                 throw new Error("Word list is empty after processing.");
            }

        } catch (error) {
            console.error("Грешка при зареждане на списъка с думи. Използване на резервен списък:", error);
            // Резервен списък при грешка на файла
            WORDS_ARRAY = ["problem", "solution", "example", "hangman", "project"];
        }
    }


    // -----------------------------------------------------------------------
    // 3. ФУНКЦИЯ ЗА API (МОДИФИЦИРАНА)
    // -----------------------------------------------------------------------
    async function fetchRandomWordAndDefinition() {
        
        // Избиране на произволна дума от локално заредения масив
        const word = WORDS_ARRAY[Math.floor(Math.random() * WORDS_ARRAY.length)];
        
        let attempts = 0;
        const MAX_ATTEMPTS = 5;

        // Опитваме се да намерим дефиниция за избраната дума
        while (attempts < MAX_ATTEMPTS) {
            try {
                let mwResponse = await fetch(`${MW_DICTIONARY_URL}${word}?key=${MW_API_KEY}`);
                
                if (!mwResponse.ok) {
                    // Грешка в MW API (напр. 404, 500), но не CORS, тъй като MW работи
                    console.error(`MW API HTTP error! status: ${mwResponse.status}`);
                    break; 
                }

                let mwData = await mwResponse.json();
                
                // Проверка за валидна дефиниция
                if (mwData && mwData[0] && mwData[0].shortdef && mwData[0].shortdef.length > 0) {
                    return {
                        word: word,
                        definition: mwData[0].shortdef[0] 
                    };
                } else {
                    // Думата е намерена, но няма дефиниция (или е много сложна/кратка), опитваме друга дума
                    attempts++;
                    continue; // Продължаваме цикъла за друга дума (в случая трябва да излезем и да се рестартира)
                }

            } catch (error) {
                console.error("Грешка при извличане на дефиниция:", error);
                break;
            }
        }
        
        // Връщане на резервен вариант при грешка или изчерпани опити
        return {
            word: word, // Връщаме последната дума, за която не намерихме дефиниция
            definition: "Definition not found or API error. Play with the word itself."
        };
    }

    
    // -----------------------------------------------------------------------
    // 4. ОСТАНАЛАТА ЛОГИКА (БЕЗ ПРОМЕНИ)
    // -----------------------------------------------------------------------
    
	function setupWordsArray(word){
		var answerArray=[];
		for(var i = 0; i < word.length; i++){
			answerArray[i] = "_";}
		return answerArray;}
	
	function updateGameState(guess, word, answerArray){
		var correctGuesses = 0;
		for (var i = 0; i < word.length; i++){
			if(guess.toLowerCase() === word[i] && answerArray[i] === "_"){
				answerArray[i] = guess; correctGuesses++;}}
		
		if (correctGuesses === 0) {pastGuesses.push(guess.toUpperCase());remainingGuesses--;}
		return correctGuesses;}
	
	function updateDisplay(answerArray, message = "") {
		$("#word-mask").text(answerArray.join(" "));
		$("#guesses-left").text(`Имате ${remainingGuesses} опита.`);
		$("#message-area").text(message);
		if (pastGuesses.length != 0) {$("#feedback-area").text(`Вече опитахте с ${pastGuesses.join(", ")}`);}
		else {$("#feedback-area").text("");}
		if (remainingGuesses <= 0 || remainingLetters <= 0) {$("#guesses-left").text(``);
            $("#guess-input, #submit-guess").prop('disabled', true);}}
    
	function endGame() {
		var finalWord = word.toUpperCase();
		if (remainingLetters === 0) {
			$("#message-area").html(`<strong>Поздравления! Отговорът е: ${finalWord}</strong>`);}
		else { $("#message-area").html(`<strong>Опитите свършиха! Думата беше: ${finalWord}</strong>`);}}


	var word;
	var answerArray;
	var remainingGuesses;
	var remainingLetters;
	var pastGuesses = [];

	function initializeGame(newWord) {
		word = newWord; 
		answerArray = setupWordsArray(word); 
		remainingGuesses = 10; 
		remainingLetters = word.length;
		pastGuesses = []; // Нулираме старите опити
		updateDisplay(answerArray, "Въведете вашата буква.");
		$("#guess-input, #submit-guess").prop('disabled', false);}
    
    
	function handleGuess() {
		var guess = $("#guess-input").val().trim().toLowerCase();
		
		
		if (guess.length !== 1 || !/^[a-z]$/.test(guess)) {
			updateDisplay(answerArray, "Моля, въведете само една валидна буква.");
			$("#guess-input").val("");
			return;}
        
        if (pastGuesses.includes(guess.toUpperCase())) {
            updateDisplay(answerArray, `Вече опитахте буквата '${guess.toUpperCase()}'. Опитайте друга.`);
            $("#guess-input").val("");
            return;
        }

		var correctGuesses = updateGameState(guess, word, answerArray); 
		
		if (correctGuesses > 0) {
			remainingLetters -= correctGuesses;
			updateDisplay(answerArray, `Поздравления! Буквата '${guess.toUpperCase()}' е намерена!`);}
		else {updateDisplay(answerArray, `Грешна буква! Няма буква '${guess.toUpperCase()}' в думата.`);}
		
		if (remainingGuesses <= 0 || remainingLetters <= 0) {endGame();}
        
		$("#guess-input").val("");}
    
    
    async function startNewGame() {
        $("#new-word-button").prop('disabled', true).text('Зареждане...');
        $("#guess-input, #submit-guess").prop('disabled', true);
        $("#word-definition").text('... Извличане на дума и дефиниция...');

        const wordData = await fetchRandomWordAndDefinition();

        $("#word-definition").text(wordData.definition);
        initializeGame(wordData.word); 

        $("#new-word-button").prop('disabled', false).text('Избери друга дума');
    }
    
	
	$(document).ready(async function() {
        // 1. Зареждаме списъка с думи преди да започнем играта
        await fetchWordList(); 
        
        // 2. Стартираме играта с първата дума
		startNewGame(); 
		
        // 3. Прикачваме събития
		$("#submit-guess").click(handleGuess);
		$("#guess-input").on('keypress', function(e) {
			if (e.which === 13) { handleGuess();}
		});
        $("#new-word-button").click(startNewGame);
	});
    
	
    </script>
	</body>

