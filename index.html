<!DOCTYPE html>

<html>

<head><title>Hangman's game</title>

	<h2>Powered with words and definitions from Merriam-Webster's Learners Dictionary<p></p>
	<img src="Merriam-Webster_logo.png"></h2>

</head>

<body style="background-color:rgb(192,226,211)">
	<h1 style="text-align:center;color:rgb(48,16,78)"><strong>This is <em>Hangman's</em> game</strong></h1>
	<p style="text-align:center"><img src="hangman.png" height=250 width=250></p>
	<p>If you want to check your spelling, go to <a href="https://www.merriam-webster.com">Merriam-Webster online</a> and good luck!</p>

	<div id="game-info" style="margin-top: 20px;">
		<h3>Word definition from Merriam-Webster's Learner Dictionary:</h3>
		<p id="word-definition" style="font-style: italic;"></p>
		<button id="new-word-button">Choose another word</button>
	</div>

	
    <div id="game-container" style="text-align: center">
        <h2 id="word-mask"></h2>    <p id="guesses-left"></p>   <p id="message-area"></p>  <p id="feedback-area"></p> 
		<label for="guess-input">Enter a letter:</label>
        <input type="text" id="guess-input" maxlength="1" style="width: 50px">
		<p></p>
        <button id="submit-guess">Check response</button>
    </div>

    <script src="https://code.jquery.com/jquery-2.1.0.js"></script>
    
    <script>
    
    // -----------------------------------------------------------------------
    // 1. КОНФИГУРАЦИЯ (API КЛЮЧОВЕ)
    // -----------------------------------------------------------------------
    const MW_API_KEY = `62ef63d6-1b72-4711-867f-2f2b6152b0da`; 
    // Уточнена е URL-ът за Learner's Dictionary (learnerS/json)
    const MW_DICTIONARY_URL = `https://www.dictionaryapi.com/api/v3/references/learners/json/`; 
    const RANDOM_WORD_URL = `https://random-word-api.herokuapp.com/word?number=1`; 

    // -----------------------------------------------------------------------
    // 2. АСИНХРОННА ЛОГИКА ЗА API (ДВУСТЪПКОВ ПРОЦЕС)
    // -----------------------------------------------------------------------
    async function fetchRandomWordAndDefinition() {
        try {
            // СТЪПКА 1: Извличане на произволна дума от външен API
            let randomResponse = await fetch(RANDOM_WORD_URL);
            let randomData = await randomResponse.json();
            const word = randomData[0].toLowerCase(); 

            // СТЪПКА 2: Извличане на дефиницията от Merriam-Webster
            let mwResponse = await fetch(`${MW_DICTIONARY_URL}${word}?key=${MW_API_KEY}`);
            
            if (!mwResponse.ok) {
                // Ако MW API върне грешка (напр. 404), опитваме отново
                console.error(`MW API HTTP error! status: ${mwResponse.status}`);
                return fetchRandomWordAndDefinition(); 
            }

            let mwData = await mwResponse.json();
            
            // Проверка за валидна дефиниция (тъй като някои произволни думи може да не са в Learner's Dictionary)
            if (mwData && mwData[0] && mwData[0].shortdef && mwData[0].shortdef.length > 0) {
                return {
                    word: word,
                    definition: mwData[0].shortdef[0] 
                };
            } else {
                // Ако няма дефиниция, опитваме отново
                return fetchRandomWordAndDefinition(); 
            }

        } catch (error) {
            console.error("Грешка при извличане на дума/дефиниция:", error);
            // Резервен вариант при мрежова грешка
            return {
                word: "error",
                definition: "API Loading Error. Please check your internet connection or console for details."
            };
        }
    }

    // -----------------------------------------------------------------------
    // 3. ФУНКЦИИ ЗА ЛОГИКАТА НА ИГРАТА
    // -----------------------------------------------------------------------
    
	function setupWordsArray(word){
		var answerArray=[];
		for(var i = 0; i < word.length; i++){
			answerArray[i] = "_";}
		return answerArray;}
	
	function updateGameState(guess, word, answerArray){
		var correctGuesses = 0;
		for (var i = 0; i < word.length; i++){
			if(guess.toLowerCase() === word[i] && answerArray[i] === "_"){
				answerArray[i] = guess; correctGuesses++;}}
		// Добавяме guessed буквата към списъка само ако е грешна
		if (correctGuesses === 0) {pastGuesses.push(guess.toUpperCase());remainingGuesses--;}
		return correctGuesses;}
	
	function updateDisplay(answerArray, message = "") {
		$("#word-mask").text(answerArray.join(" "));
		$("#guesses-left").text(`Имате ${remainingGuesses} опита.`);
		$("#message-area").text(message);
		if (pastGuesses.length != 0) {$("#feedback-area").text(`Вече опитахте с ${pastGuesses.join(", ")}`);}
		else {$("#feedback-area").text("Все още нямате въведени букви.");}
		if (remainingGuesses <= 0 || remainingLetters <= 0) {
            $("#guess-input, #submit-guess").prop('disabled', true);}}
    
	function endGame() {
		var finalWord = word.toUpperCase();
		if (remainingLetters === 0) {
			$("#message-area").html(`<strong>Поздравления! Отговорът е: ${finalWord}</strong>`);}
		else { $("#message-area").html(`<strong>Опитите свършиха! Думата беше: ${finalWord}</strong>`);}}


	var word;
	var answerArray;
	var remainingGuesses;
	var remainingLetters;
	var pastGuesses = [];

    // Приема дума като аргумент от API
	function initializeGame(newWord) {
		word = newWord; 
		answerArray = setupWordsArray(word); 
		remainingGuesses = 10; 
		remainingLetters = word.length;
		pastGuesses = []; // Нулираме старите опити
		updateDisplay(answerArray, "Въведете вашата буква.");
		$("#guess-input, #submit-guess").prop('disabled', false);}
    
    
    // ⭐ ЛИПСВАЩАТА ФУНКЦИЯ, КОЯТО ПРАВЕШЕ БУТОНА ДА НЕ РАБОТИ
	function handleGuess() {
		var guess = $("#guess-input").val().trim().toLowerCase();
		
		// 1. Валидация на въведеното
		if (guess.length !== 1 || !/^[a-z]$/.test(guess)) {
			updateDisplay(answerArray, "Моля, въведете само една валидна буква.");
			$("#guess-input").val("");
			return;}
        
        // 2. Проверка за вече въведена буква
        if (pastGuesses.includes(guess.toUpperCase())) {
            updateDisplay(answerArray, `Вече опитахте буквата '${guess.toUpperCase()}'. Опитайте друга.`);
            $("#guess-input").val("");
            return;
        }

        // 3. Актуализиране на състоянието
		var correctGuesses = updateGameState(guess, word, answerArray); 
		
		if (correctGuesses > 0) {
			remainingLetters -= correctGuesses;
			updateDisplay(answerArray, `Поздравления! Буквата '${guess.toUpperCase()}' е намерена!`);}
		else {updateDisplay(answerArray, `Грешна буква! Няма буква '${guess.toUpperCase()}' в думата.`);}
		
        // 4. Проверка за край
		if (remainingGuesses <= 0 || remainingLetters <= 0) {endGame();}
        
        // 5. Почистване на полето
		$("#guess-input").val("");}
    
    // -----------------------------------------------------------------------
    // 4. СТАРТИРАНЕ/РЕСТАРТИРАНЕ НА ИГРАТА (ЗА БУТОНА)
    // -----------------------------------------------------------------------
    async function startNewGame() {
        // 1. Деактивираме контролите
        $("#new-word-button").prop('disabled', true).text('Зареждане...');
        $("#guess-input, #submit-guess").prop('disabled', true);
        $("#word-definition").text('... Извличане на дума и дефиниция...');

        // 2. Извикваме асинхронната функция
        const wordData = await fetchRandomWordAndDefinition();

        // 3. Актуализираме дисплея и инициализираме играта
        $("#word-definition").text(wordData.definition);
        initializeGame(wordData.word); 

        // 4. Активираме контролите
        $("#new-word-button").prop('disabled', false).text('Избери друга дума');
    }
    
	// -----------------------------------------------------------------------
    // 5. ПРИКАЧВАНЕ НА СЪБИТИЯ (jQuery)
    // -----------------------------------------------------------------------
	$(document).ready(function() {
        // Стартираме играта с API заявка
		startNewGame(); 
		
        // Прикачваме събития
		$("#submit-guess").click(handleGuess);
		$("#guess-input").on('keypress', function(e) {
			if (e.which === 13) { handleGuess();}
		});
        $("#new-word-button").click(startNewGame);
	});
    
	
    </script>
	</body>